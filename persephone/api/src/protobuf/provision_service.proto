/* [START declaration] */
syntax = "proto3";
package com.vmware.blockchain.deployment.model;

import "concord_cluster.proto";
import "concord_model.proto";
import "core.proto";
import "orchestration.proto";
/* [END declaration] */

/* [START java_declaration] */
option java_package = "com.vmware.blockchain.deployment.model.jvm";
option java_multiple_files = true;
/* [END java_declaration] */

/* [START messages] */
/**
 * Model definition of Concord cluster placement specification.
 *
 * @property[entries]
 *   list of placement entries mapping replica deployment to orchestration site targets. The
 *   positional sequence in the collection corresponds to the index of the Concord replica to be
 *   placed.
 */
message PlacementSpecification {
    enum Type {
        UNSPECIFIED = 0;
        FIXED = 1;
    }

    message PlacementEntry {
        Type type = 1;
        OrchestrationSiteIdentifier site = 2;
    }

    repeated PlacementEntry entries = 1;
}

/**
 * Model definition of cluster deployment specification.
 *
 * @property[cluster_size]
 *   size of the cluster to deploy.
 * @property[model]
 *   versioned Concord model to use for nodes in the cluster.
 * @property[placement]
 *   cluster placement specification.
 */
message DeploymentSpecification {
    uint32 cluster_size = 1;
    ConcordModelIdentifier model = 2;
    PlacementSpecification placement = 3;
}

/**
 * Denote the identifier of a deployment session.
 *
 * @property[low]
 *   lower order bits of a 128-bit identifier;
 * @property[high]
 *   higher order bits of a 128-bit identifier;
 */
message DeploymentSessionIdentifier {
    uint64 low = 1;
    uint64 high = 2;
}

/**
 * Model definition for events pertaining to a cluster deployment session.
 *
 * @property[header]
 *   message header.
 * @property[type]
 *   type of event.
 * @property[session]
 *   identifier for the cluster deployment session.
 * @property[node]
 *   Concord node information for node-related events.
 * @property[cluster]
 *   Concord cluster information for the created cluster resource.
 */
message DeploymentSessionEvent {
    /**
     * Type of [DeploymentEvent] emitted.
     */
    enum Type {
        NOOP = 0; // Default value, should not be used.
        ACKNOWLEDGED = 1; // Request acknowledged (session associated with [deployment] is recorded).
        NODE_DEPLOYED = 2; // Node specified by [node] is deployed.
        NODE_STATUS = 3; // Status update for a node specified in [node_status].
        CLUSTER_DEPLOYED = 4; // Cluster specified by [cluster] is fully deployed.
        COMPLETED = 5; // Session completed (plan associated with [deployment] is marked complete).
    }

    MessageHeader header = 1;
    Type type = 2;
    DeploymentSessionIdentifier session = 3;
    ConcordNode node = 4;
    ConcordNodeStatus node_status = 5;
    ConcordCluster cluster = 6;
}

/**
 * Request definition for operation to create a Concord cluster.
 *
 * @property[header]
 *   message header.
 * @property[specification]
 *   cluster deployment specification.
 */
message CreateClusterRequest {
    MessageHeader header = 1;
    DeploymentSpecification specification = 2;
}

/**
 * Request definition for operation to retrieve [DeploymentEvent]s related to a deployment session.
 *
 * @property[header]
 *   message header.
 * @property[session]
 *   identifier for the cluster deployment session.
 */
message GetClusterDeploymentSessionEventRequest {
    MessageHeader header = 1;
    DeploymentSessionIdentifier session = 2;
}
/* [END messages] */

/* [START services] */
/**
 * Service definition pertaining to operations on Concord cluster provisioning.
 */
service ProvisionService {
    /**
     * Operation to create a cluster based on a [CreateClusterRequest].
     */
    rpc CreateCluster (CreateClusterRequest) returns (DeploymentSessionIdentifier) {};
    rpc GetClusterDeploymentSessionEvents (GetClusterDeploymentSessionEventRequest)
        returns (stream DeploymentSessionEvent) {};
}
/* [END services] */
