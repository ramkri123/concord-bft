## IMPORTANT: You must have initialized and updated the submodules
## before building the docker image! See README.md.

## ALSO IMPORTANT: You must pass the parent directory as the path for
## this build. We need to copy files from ../communication, and Docker
## will not allow copying files from outside the build scope. Use either:
##
## from this directory: docker build -f Dockerfile ..
##         from parent: docker build -f concord/Dockerfile .

## Build image
FROM athena-docker-local.artifactory.eng.vmware.com/concord-core:prereqs-v9

## Remember context is the parent of this directory
COPY ./communication /communication

## Copy the blockchain repo .git directory so submodules can run git commands
## While this is somewhat dirty it makes the relative path in
## concord/submodule/concord-bft/.git work. Alternatively, we could change all
## the paths and copy the entire blockchain dir to /blockchain. However, this
## works fine, is a one line change, and the docker image is destroyed after
## build anyway.
COPY .git /.git

WORKDIR /concord
COPY ./concord /concord
WORKDIR /concord/build
RUN cmake -DCMAKE_C_COMPILER=/usr/bin/clang-7 -DCMAKE_CXX_COMPILER=/usr/bin/clang++-7 -DCMAKE_CXX_FLAGS="-march=x86-64 -mtune=generic" .. && CTEST_OUTPUT_ON_FAILURE=true make -j$(nproc) all test

## Base Run image
FROM ubuntu:18.04
LABEL Description="Concord"

ARG memleak_util=""
ARG memleak_util_cmd=""

# Get this variable into the docker image for the CMD.
ENV memleak_util_cmd="${memleak_util_cmd}"

RUN apt-get update \
    && apt-get -y install ${memleak_util} \
    bind9-host \
    dnsutils \
    libboost-atomic1.65.1 \
    libboost-chrono1.65.1 \
    libboost-date-time1.65.1 \
    libboost-filesystem1.65.1 \
    libboost-program-options1.65.1 \
    libboost-system1.65.1 \
    libboost-thread1.65.1 \
    libbz2-1.0 \
    libgmp10 \
    liblz4-1 \
    libprotobuf10 \
    libsnappy1v5 \
    libzstd1 \
    libyaml-cpp0.5v5 \
    llvm-5.0 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=0 /usr/local/lib/libcryptopp* /usr/local/lib/
COPY --from=0 /usr/local/lib/liblog4cplus* /usr/local/lib/
COPY --from=0 /opt/protobuf /opt/protobuf
COPY --from=0 /opt/grpc /opt/grpc

# Go is required because chaincode installation will
# compile the chaincode source file to binary.
COPY --from=0 /usr/local/go /usr/local/go

# evmjit is statically compiled, so we don't need to copy
COPY --from=0 /usr/local/lib/librelic* /usr/local/lib/
COPY --from=0 /usr/local/lib/librocksdb.* /usr/local/lib/
COPY --from=0 /usr/local/lib/libsecp256k1* /usr/local/lib/

WORKDIR /concord/resources
COPY --from=0 /concord/build/src/concord /concord/concord
COPY --from=0 /concord/build/tools/conc_* /concord/
COPY --from=0 /concord/build/tools/ec* /concord/
COPY ./concord/test/concord.supp /concord/concord.supp

# HLF
# explicity want to copy default peer executable from hyperledger/fabric_tools version 1.3.1 
# any other hyperledeger fabric version creates undefined behaviour ( bug )
COPY --from=vmwblockchain/fabric-tools:v131  /usr/local/bin/peer /concord/
# this is not the same peer that communicates with concord kv state ie: vmwblockchain/fabric_peer 
# this tools:v131 peer is only for command line system calls for sending chaincode commands
# from c++ concord to our custom golang peer defined in submodules/hlf-chcaincode-engine/Dockerfile-peer
# built from 'integrate2concord' git branch and tagged as {hlf_peer_base}:{hlf_peer_base_tag}

# HLF_HARDCODED_CONFIG
COPY ./docker/hlf/crypto-config/ /concord/crypto-config
COPY ./docker/hlf/core.yaml /concord
# _HLF_HARDCODED_CONFIG

# Copy default Concord logger configuration so logging will be sanely configured
# if no custom configuration was provided when the cluster was set up.
COPY ./concord/resources/log4cplus.properties /concord/resources/log4cplus.properties

# Management port
EXPOSE 5458

# Ledger API service
EXPOSE 50051

# SBFT ports.
EXPOSE 3501/tcp
EXPOSE 3502/tcp
EXPOSE 3503/tcp
EXPOSE 3504/tcp
EXPOSE 3505/tcp

EXPOSE 3501/udp
EXPOSE 3502/udp
EXPOSE 3503/udp
EXPOSE 3504/udp
EXPOSE 3505/udp

# ENV
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/opt/grpc/lib:/opt/protobuf/lib
ENV GOPATH=/concord
ENV PATH=$PATH:/usr/local/go/bin

# Mountable volumes.
VOLUME [ "/concord/config", "/concord/rocksdbdata", "/concord/log", "/concord/tls_certs" ]

# Set working directory and start.
WORKDIR /concord
CMD cp /concord/config-local/concord_with_hostnames.config \
    /concord/config-local/concord.config && \
    /concord/config-public/find-docker-instances.sh && \
    ${memleak_util_cmd} \
    /concord/concord -c /concord/config-local/concord.config
